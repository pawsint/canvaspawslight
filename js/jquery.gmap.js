(function(a){"use strict";var b=function(){this.markers=[];this.mainMarker=false;this.icon="http://www.google.com/mapfiles/marker.png"};b.prototype.dist=function(a){return Math.sqrt(Math.pow(this.markers[0].latitude-a.latitude,2)+Math.pow(this.markers[0].longitude-a.longitude,2))};b.prototype.setIcon=function(a){this.icon=a};b.prototype.addMarker=function(a){this.markers[this.markers.length]=a};b.prototype.getMarker=function(){if(this.mainmarker){return this.mainmarker}var a,b;if(this.markers.length>1){a=new c.MarkerImage("http://thydzik.com/thydzikGoogleMap/markerlink.html?text="+this.markers.length+"&color=EF9D3F");b="cluster of "+this.markers.length+" markers"}else{a=new c.MarkerImage(this.icon);b=this.markers[0].title}this.mainmarker=new c.Marker({position:new c.LatLng(this.markers[0].latitude,this.markers[0].longitude),icon:a,title:b,map:null});return this.mainmarker};var c=google.maps,d=new c.Geocoder,e=0,f={};f={init:function(b){var d,e=a.extend({},a.fn.gMap.defaults,b);for(d in a.fn.gMap.defaults.icon){if(!e.icon[d]){e.icon[d]=a.fn.gMap.defaults.icon[d]}}return this.each(function(){var b=a(this),d=f._getMapCenter.apply(b,[e]),g,h;if(e.zoom=="fit"){e.zoom=f.autoZoom.apply(b,[e])}var i={zoom:e.zoom,center:d,mapTypeControl:e.mapTypeControl,zoomControl:e.zoomControl,panControl:e.panControl,scaleControl:e.scaleControl,streetViewControl:e.streetViewControl,mapTypeId:e.maptype,scrollwheel:e.scrollwheel,maxZoom:e.maxZoom,minZoom:e.minZoom},j=new c.Map(this,i);if(e.log){console.log("map center is:")}if(e.log){console.log(d)}b.data("$gmap",j);b.data("gmap",{opts:e,gmap:j,markers:[],markerKeys:{},infoWindow:null,clusters:[]});if(e.controls.length!==0){for(g=0;g<e.controls.length;g+=1){j.controls[e.controls[g].pos].push(e.controls[g].div)}}if(e.clustering){h=b.data("gmap");(function(a){h.markers=a})(e.markers);f.renderCluster.apply(b,[]);c.event.addListener(j,"bounds_changed",function(){f.renderCluster.apply(b,[])})}else{if(e.markers.length!==0){f.addMarkers.apply(b,[e.markers])}}f._onComplete.apply(b,[])})},_onComplete:function(){var a=this.data("gmap"),b=this;if(e!==0){window.setTimeout(function(){f._onComplete.apply(b,[])},1e3);return}a.opts.onComplete()},renderCluster:function(){var a=this.data("gmap"),c=a.markers,d=a.clusters,e=a.opts,g,h,i;for(g=0;g<d.length;g+=1){d[g].getMarker().setMap(null)}d.length=0;i=a.gmap.getBounds();if(!i){var j=this;window.setTimeout(function(){f.renderCluster.apply(j)},1e3);return}var k=i.getNorthEast(),l=i.getSouthWest(),m=k.lat()-l.lat(),n=[],o,p,q=m*e.clusterSize/100,r,s;for(g=0;g<c.length;g+=1){if(c[g].latitude<k.lat()&&c[g].latitude>l.lat()&&c[g].longitude<k.lng()&&c[g].longitude>l.lng()){n[n.length]=c[g]}}if(e.log){console.log("number of markers "+n.length+"/"+c.length)}if(e.log){console.log("cluster radius: "+q)}for(g=0;g<n.length;g+=1){p=1e4;o=-1;for(h=0;h<d.length;h+=1){r=d[h].dist(n[g]);if(r<q){p=r;o=h;if(e.fastClustering){break}}}if(o===-1){s=new b;s.addMarker(n[g]);d[d.length]=s}else{d[o].addMarker(n[g])}}if(e.log){console.log("Total clusters in viewport: "+d.length)}for(h=0;h<d.length;h+=1){d[h].getMarker().setMap(a.gmap)}},_setMapCenter:function(a){var b=this.data("gmap");if(b.opts.log){console.log("delayed setMapCenter called")}if(b.gmap!==undefined){b.gmap.setCenter(a)}else{var c=this;window.setTimeout(function(){f._setMapCenter.apply(c,[a])},500)}},_boundaries:null,_getBoundaries:function(a){if(f._boundaries){return f._boundaries}var b=a.markers[0].latitude,c=a.markers[0].longitude,d=a.markers[0].longitude,e=a.markers[0].latitude,g;for(g=1;g<a.markers.length;g+=1){if(b>a.markers[g].latitude){b=a.markers[g].latitude}if(c<a.markers[g].longitude){c=a.markers[g].longitude}if(d>a.markers[g].longitude){d=a.markers[g].longitude}if(e<a.markers[g].latitude){e=a.markers[g].latitude}}f._boundaries={N:b,E:c,W:d,S:e};return f._boundaries},_getMapCenter:function(a){var b,e=this,g,h,i;if(a.markers.length&&(a.latitude=="fit"||a.longitude=="fit")){i=f._getBoundaries(a);b=new c.LatLng((i.N+i.S)/2,(i.E+i.W)/2);return b}if(a.latitude&&a.longitude){b=new c.LatLng(a.latitude,a.longitude);return b}else{b=new c.LatLng(0,0)}if(a.address){d.geocode({address:a.address},function(b,c){if(c===google.maps.GeocoderStatus.OK){f._setMapCenter.apply(e,[b[0].geometry.location])}else{if(a.log){console.log("Geocode was not successful for the following reason: "+c)}}});return b}if(a.markers.length>0){h=null;for(g=0;g<a.markers.length;g+=1){if(a.markers[g].setCenter){h=a.markers[g];break}}if(h===null){for(g=0;g<a.markers.length;g+=1){if(a.markers[g].latitude&&a.markers[g].longitude){h=a.markers[g];break}if(a.markers[g].address){h=a.markers[g]}}}if(h===null){return b}if(h.latitude&&h.longitude){return new c.LatLng(h.latitude,h.longitude)}if(h.address){d.geocode({address:h.address},function(b,c){if(c===google.maps.GeocoderStatus.OK){f._setMapCenter.apply(e,[b[0].geometry.location])}else{if(a.log){console.log("Geocode was not successful for the following reason: "+c)}}})}}return b},setZoom:function(b){var c=this.data("gmap").gmap,b;if(b==="fit"){b=f.autoZoom.apply(a(this),[])}c.setZoom(parseInt(b))},getRoute:function(b){var d=this.data("gmap"),e=d.gmap,f=new c.DirectionsRenderer,g=new c.DirectionsService,h={BYCAR:c.DirectionsTravelMode.DRIVING,BYBICYCLE:c.DirectionsTravelMode.BICYCLING,BYFOOT:c.DirectionsTravelMode.WALKING},i={MILES:c.DirectionsUnitSystem.IMPERIAL,KM:c.DirectionsUnitSystem.METRIC},j=null,k=null,l=null,m=null;if(b.routeDisplay!==undefined){j=b.routeDisplay instanceof jQuery?b.routeDisplay[0]:typeof b.routeDisplay=="string"?a(b.routeDisplay)[0]:null}else if(d.opts.routeDisplay!==null){j=d.opts.routeDisplay instanceof jQuery?d.opts.routeDisplay[0]:typeof d.opts.routeDisplay=="string"?a(d.opts.routeDisplay)[0]:null}f.setMap(e);if(j!==null){f.setPanel(j)}k=h[d.opts.travelMode]!==undefined?h[d.opts.travelMode]:h["BYCAR"];l=i[d.opts.travelUnit]!==undefined?i[d.opts.travelUnit]:i["KM"];var n={origin:b.from,destination:b.to,travelMode:k,unitSystem:l};g.route(n,function(b,e){if(e==c.DirectionsStatus.OK){f.setDirections(b)}else if(j!==null){a(j).html(d.opts.routeErrors[e])}});return this},processMarker:function(a,b,d,e){var f=this.data("gmap"),g=f.gmap,h=f.opts,i,j;if(e===undefined){e=new c.LatLng(a.latitude,a.longitude)}if(!b){var k={image:h.icon.image,iconSize:new c.Size(h.icon.iconsize[0],h.icon.iconsize[1]),iconAnchor:new c.Point(h.icon.iconanchor[0],h.icon.iconanchor[1]),infoWindowAnchor:new c.Size(h.icon.infowindowanchor[0],h.icon.infowindowanchor[1])};b=new c.MarkerImage(k.image,k.iconSize,null,k.iconAnchor)}if(!d){var l={image:h.icon.shadow,iconSize:new c.Size(h.icon.shadowsize[0],h.icon.shadowsize[1]),anchor:k&&k.iconAnchor?k.iconAnchor:new c.Point(h.icon.iconanchor[0],h.icon.iconanchor[1])}}j={position:e,icon:b,title:a.title,map:null};if(!h.clustering){j.map=g}i=new c.Marker(j);i.setShadow(d);f.markers.push(i);if(a.key){f.markerKeys[a.key]=i}var m;if(a.html){var n=typeof a.html==="string"?h.html_prepend+a.html+h.html_append:a.html;var o={content:n,pixelOffset:a.infoWindowAnchor};if(h.log){console.log("setup popup with data")}if(h.log){console.log(o)}m=new c.InfoWindow(o);c.event.addListener(i,"click",function(){if(h.log){console.log("opening popup "+a.html)}if(h.singleInfoWindow&&f.infoWindow){f.infoWindow.close()}m.open(g,i);f.infoWindow=m})}if(a.html&&a.popup){if(h.log){console.log("opening popup "+a.html)}m.open(g,i);f.infoWindow=m}},_geocodeMarker:function(a,b,g){e+=1;var h=this;d.geocode({address:a.address},function(d,i){e-=1;if(i===c.GeocoderStatus.OK){if(h.data("gmap").opts.log){console.log("Geocode was successful with point: ",d[0].geometry.location)}f.processMarker.apply(h,[a,b,g,d[0].geometry.location])}else{if(h.data("gmap").opts.log){console.log("Geocode was not successful for the following reason: "+i)}}})},autoZoom:function(a){var b=this.data("gmap"),a=b?b.opts:a,c,d,e,g,h=39135.758482;if(a.log){console.log("autozooming map")}d=f._getBoundaries(a);e=(d.E-d.W)*111e3/this.width();g=(d.S-d.N)*111e3/this.height();for(c=2;c<20;c+=1){if(e>h||g>h){break}h=h/2}return c-2},addMarkers:function(b){var c=this.data("gmap").opts;if(b.length!==0){if(c.log){console.log("adding "+b.length+" markers")}for(var d=0;d<b.length;d+=1){f.addMarker.apply(a(this),[b[d]])}}return this},addMarker:function(a){var b=this.data("gmap").opts;if(b.log){console.log("putting marker at "+a.latitude+", "+a.longitude+" with address "+a.address+" and html "+a.html)}var d={image:b.icon.image,iconSize:new c.Size(b.icon.iconsize[0],b.icon.iconsize[1]),iconAnchor:new c.Point(b.icon.iconanchor[0],b.icon.iconanchor[1]),infoWindowAnchor:new c.Size(b.icon.infowindowanchor[0],b.icon.infowindowanchor[1])},e={image:b.icon.shadow,iconSize:new c.Size(b.icon.shadowsize[0],b.icon.shadowsize[1]),anchor:d.iconAnchor};a.infoWindowAnchor=d.infoWindowAnchor;if(a.icon){if(a.icon.image){d.image=a.icon.image}if(a.icon.iconsize){d.iconSize=new c.Size(a.icon.iconsize[0],a.icon.iconsize[1])}if(a.icon.iconanchor){d.iconAnchor=new c.Point(a.icon.iconanchor[0],a.icon.iconanchor[1])}if(a.icon.infowindowanchor){d.infoWindowAnchor=new c.Size(a.icon.infowindowanchor[0],a.icon.infowindowanchor[1])}if(a.icon.shadow){e.image=a.icon.shadow}if(a.icon.shadowsize){e.iconSize=new c.Size(a.icon.shadowsize[0],a.icon.shadowsize[1])}}var g=new c.MarkerImage(d.image,d.iconSize,null,d.iconAnchor);var h=new c.MarkerImage(e.image,e.iconSize,null,e.anchor);if(a.address){if(a.html==="_address"){a.html=a.address}if(a.title=="_address"){a.title=a.address}if(b.log){console.log("geocoding marker: "+a.address)}f._geocodeMarker.apply(this,[a,g,h])}else{if(a.html==="_latlng"){a.html=a.latitude+", "+a.longitude}if(a.title=="_latlng"){a.title=a.latitude+", "+a.longitude}var i=new c.LatLng(a.latitude,a.longitude);f.processMarker.apply(this,[a,g,h,i])}return this},removeAllMarkers:function(){var a=this.data("gmap").markers,b;for(b=0;b<a.length;b+=1){a[b].setMap(null);delete a[b]}a.length=0},getMarker:function(a){return this.data("gmap").markerKeys[a]},fixAfterResize:function(a){var b=this.data("gmap");c.event.trigger(b.gmap,"resize");if(a){b.gmap.panTo(new google.maps.LatLng(0,0))}b.gmap.panTo(this.gMap("_getMapCenter",b.opts))}};a.fn.gMap=function(b){if(f[b]){return f[b].apply(this,Array.prototype.slice.call(arguments,1))}else if(typeof b==="object"||!b){return f.init.apply(this,arguments)}else{a.error("Method "+b+" does not exist on jQuery.gmap")}};a.fn.gMap.defaults={log:false,address:"",latitude:null,longitude:null,zoom:3,maxZoom:null,minZoom:null,markers:[],controls:{},scrollwheel:true,maptype:google.maps.MapTypeId.ROADMAP,mapTypeControl:true,zoomControl:true,panControl:false,scaleControl:false,streetViewControl:true,singleInfoWindow:true,html_prepend:'<div class="gmap_marker">',html_append:"</div>",icon:{image:"http://www.google.com/mapfiles/marker.png",iconsize:[20,34],iconanchor:[9,34],infowindowanchor:[9,2],shadow:"http://www.google.com/mapfiles/shadow50.png",shadowsize:[37,34]},onComplete:function(){},travelMode:"BYCAR",travelUnit:"KM",routeDisplay:null,routeErrors:{INVALID_REQUEST:"The provided request is invalid.",NOT_FOUND:"One or more of the given addresses could not be found.",OVER_QUERY_LIMIT:"A temporary error occured. Please try again in a few minutes.",REQUEST_DENIED:"An error occured. Please contact us.",UNKNOWN_ERROR:"An unknown error occured. Please try again.",ZERO_RESULTS:"No route could be found within the given addresses."},clustering:false,fastClustering:false,clusterCount:10,clusterSize:40}})(jQuery)